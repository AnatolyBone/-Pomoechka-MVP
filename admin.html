<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–º–æ–µ—á–∫–∞ ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å üóëÔ∏è</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Eruda –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ Telegram -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        html { font-size: 14px; }
        body { overflow-x: hidden; }
        
        /* Sidebar - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .sidebar { 
            transition: transform 0.3s ease; 
            width: 220px;
            min-width: 220px;
            transform: translateX(-100%);
        }
        .sidebar.open { transform: translateX(0); }
        
        /* Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º sidebar */
        @media (min-width: 768px) {
            .sidebar { transform: translateX(0) !important; }
            .sidebar-overlay { display: none !important; }
            .main-content { margin-left: 220px; }
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .stat-card { transition: all 0.2s ease; }
        .stat-card p.text-3xl { font-size: 1.5rem; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 600; display: inline-block; }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-taken { background: #e0e7ff; color: #3730a3; }
        .status-expired { background: #fef3c7; color: #92400e; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-resolved { background: #d1fae5; color: #065f46; }
        .status-hidden { background: #fee2e2; color: #991b1b; }
        
        .nav-link { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .hidden { display: none !important; }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        .p-6 { padding: 1rem; }
        .gap-6 { gap: 0.75rem; }
        .mb-8 { margin-bottom: 1rem; }
        .rounded-2xl { border-radius: 1rem; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { text-align: left; padding: 8px 4px; }
        
        /* Header –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
        header h2 { font-size: 1rem; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stat-card { padding: 0.75rem; }
        .stat-card span.text-3xl { font-size: 1.5rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4">üîê</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p class="text-gray-500 mb-6">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>
            
            <div id="authStatus" class="mb-6">
                <div class="animate-pulse flex items-center justify-center gap-2 text-gray-500">
                    <div class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞...
                </div>
            </div>
            
            <div id="authError" class="hidden bg-red-50 text-red-700 p-4 rounded-xl mb-4">
                <p class="font-semibold">‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</p>
                <p class="text-sm mt-1">–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
            
            <div id="authSetup" class="hidden bg-blue-50 text-blue-700 p-4 rounded-xl mb-4 text-left">
                <p class="font-semibold mb-2">üîß –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</p>
                <p class="text-sm mb-2">–≠—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫. –í–∞—à Telegram ID –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ —Å–æ–∑–¥–∞—Ç–µ–ª—å:</p>
                <code id="setupUserId" class="block bg-blue-100 px-3 py-2 rounded text-center font-mono text-lg"></code>
                <input id="setupBotToken" type="text" placeholder="–¢–æ–∫–µ–Ω –±–æ—Ç–∞ (123456789:ABCdef...)" 
                       class="w-full mt-3 px-3 py-2 border border-blue-300 rounded-lg text-sm">
                <p class="text-xs text-blue-600 mt-1">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</p>
                <button onclick="setupCreator()" class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                    ‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –≤–æ–π—Ç–∏
                </button>
            </div>
            
            <div id="authNotTelegram" class="hidden bg-amber-50 text-amber-700 p-4 rounded-xl">
                <p class="font-semibold">üì± –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram</p>
                <p class="text-sm mt-1">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram Mini App</p>
            </div>
            
            <a href="index.html" class="inline-block mt-4 text-gray-500 hover:text-gray-700">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
            </a>
        </div>
    </div>

    <!-- Admin Panel (hidden until authenticated) -->
    <div id="adminPanel" class="hidden">
        
        <!-- Overlay –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 bg-gray-900 text-white">
            <div class="flex items-center gap-3 p-6 border-b border-gray-800">
                <span class="text-3xl">üóëÔ∏è</span>
                <div>
                    <h1 class="font-bold text-lg">–ü–æ–º–æ–µ—á–∫–∞</h1>
                    <p class="text-xs text-gray-400">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</p>
                </div>
            </div>
            
            <!-- Admin info -->
            <div class="px-6 py-4 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <div id="adminAvatar" class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center font-bold">?</div>
                    <div>
                        <p id="adminName" class="font-semibold text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                        <p id="adminRole" class="text-xs text-gray-400">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                    </div>
                </div>
            </div>
            
            <nav class="p-3 space-y-1">
                <a href="#dashboard" onclick="showSection('dashboard'); closeSidebar();" class="nav-link px-3 py-2 rounded-lg bg-emerald-600 text-white">
                    <span>üìä</span> –î–∞—à–±–æ—Ä–¥
                </a>
                <a href="#items" onclick="showSection('items'); closeSidebar();" class="nav-link px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
                    <span>üì¶</span> –û–±—ä—è–≤–ª–µ–Ω–∏—è
                </a>
                <a href="#reports" onclick="showSection('reports'); closeSidebar();" class="nav-link px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
                    <span>‚ö†Ô∏è</span> –ñ–∞–ª–æ–±—ã
                    <span id="reportsBadge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </a>
                <a href="#settings" onclick="showSection('settings'); closeSidebar();" class="nav-link px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
                    <span>‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
            </nav>
            
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-800">
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white">
                    <span>üì±</span> –ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content min-h-screen">
            
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-40">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-600 text-2xl">‚ò∞</button>
                    <h2 id="sectionTitle" class="text-xl font-bold text-gray-800">üìä –î–∞—à–±–æ—Ä–¥</h2>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500" id="lastUpdate">‚Äî</span>
                    <button onclick="refreshData()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-semibold hover:bg-emerald-600">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="section-dashboard" class="p-6">
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-3xl">üì¶</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-800" id="stat-total">0</p>
                        <p class="text-sm text-gray-500">–í—Å–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>
                    </div>
                    
                    <div class="stat-card bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-3xl">üü¢</span>
                        </div>
                        <p class="text-3xl font-bold text-emerald-600" id="stat-active">0</p>
                        <p class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
                    </div>
                    
                    <div class="stat-card bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-3xl">‚úÖ</span>
                        </div>
                        <p class="text-3xl font-bold text-blue-600" id="stat-taken">0</p>
                        <p class="text-sm text-gray-500">–ó–∞–±—Ä–∞–ª–∏</p>
                    </div>
                    
                    <div class="stat-card bg-white rounded-2xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-3xl">‚ö†Ô∏è</span>
                        </div>
                        <p class="text-3xl font-bold text-amber-600" id="stat-reports">0</p>
                        <p class="text-sm text-gray-500">–ñ–∞–ª–æ–± –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">üìà –°—Ç–∞—Ç—É—Å—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h3>
                        <canvas id="statusChart" height="200"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">üè∑Ô∏è –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                        <canvas id="categoriesChart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Recent Items -->
                <div class="bg-white rounded-2xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-800">üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
                        <a href="#items" onclick="showSection('items')" class="text-emerald-600 text-sm font-semibold">–í—Å–µ ‚Üí</a>
                    </div>
                    <div id="recentItems" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
                
            </section>

            <!-- Items Section -->
            <section id="section-items" class="p-6 hidden">
                
                <!-- Filters -->
                <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 flex flex-wrap gap-4 items-center">
                    <input type="text" id="itemSearch" placeholder="üîç –ü–æ–∏—Å–∫..." 
                           class="flex-1 min-w-[200px] px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                           oninput="filterItems()">
                    
                    <select id="itemStatus" class="px-4 py-2 border border-gray-200 rounded-lg" onchange="filterItems()">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="taken">‚úÖ –ó–∞–±—Ä–∞–ª–∏</option>
                        <option value="expired">‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
                        <option value="hidden">üö´ –°–∫—Ä—ã—Ç–æ</option>
                    </select>
                    
                    <button onclick="exportItems()" class="px-4 py-2 bg-gray-100 rounded-lg text-sm font-semibold hover:bg-gray-200">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                </div>
                
                <!-- Items Table -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–ù–∞—Ö–æ–¥–∫–∞</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–ê–≤—Ç–æ—Ä</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–ñ–∞–ª–æ–±—ã</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–î–∞—Ç–∞</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>
                
            </section>

            <!-- Reports Section -->
            <section id="section-reports" class="p-6 hidden">
                
                <div class="bg-white rounded-2xl p-4 shadow-sm mb-6 flex flex-wrap gap-4 items-center">
                    <select id="reportStatus" class="px-4 py-2 border border-gray-200 rounded-lg" onchange="filterReports()">
                        <option value="">–í—Å–µ –∂–∞–ª–æ–±—ã</option>
                        <option value="pending">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                        <option value="resolved">‚úÖ –†–µ—à–µ–Ω–æ</option>
                    </select>
                    
                    <div class="flex-1"></div>
                    
                    <span class="text-sm text-gray-500" id="pendingCount">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                
                <!-- Reports List -->
                <div id="reportsList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="p-6 hidden">
                
                <div class="max-w-2xl space-y-6">
                    
                    <!-- Creator Only: Admin Management -->
                    <div id="creatorSettings" class="hidden bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</h3>
                        <p class="text-sm text-gray-500 mb-4">–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º —Ä–∞–∑–¥–µ–ª–æ–º</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ID –°–æ–∑–¥–∞—Ç–µ–ª—è</label>
                                <input type="text" id="creatorIdDisplay" readonly
                                       class="w-full px-4 py-2 bg-gray-100 rounded-lg font-mono">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (Telegram ID)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="newAdminId" placeholder="123456789"
                                           class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                    <button onclick="addAdmin()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-semibold hover:bg-emerald-600">
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–∫—É—â–∏–µ –∞–¥–º–∏–Ω—ã</label>
                                <div id="adminsList" class="space-y-2">
                                    <p class="text-gray-500 text-sm">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- General Settings -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">‚öôÔ∏è –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (—á–∞—Å–æ–≤)</label>
                                <input type="number" id="settingLifetime" value="6" min="1" max="24" 
                                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">–¢—Ä–µ–±–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</p>
                                    <p class="text-sm text-gray-500">–û–±—ä—è–≤–ª–µ–Ω–∏—è –±–µ–∑ —Ñ–æ—Ç–æ –Ω–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="settingRequirePhoto" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">–ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∂–∞–ª–æ–±–∞—Ö</p>
                                    <p class="text-sm text-gray-500">–°–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ 3 –∂–∞–ª–æ–±</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="settingAutoHide" checked class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Karma Settings -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4">‚≠ê –°–∏—Å—Ç–µ–º–∞ –∫–∞—Ä–º—ã</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é</label>
                                <input type="number" id="karmaPublish" value="10" min="0" max="100" 
                                       class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ï—Å–ª–∏ –∑–∞–±—Ä–∞–ª–∏</label>
                                <input type="number" id="karmaTaken" value="25" min="0" max="100" 
                                       class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="bg-red-50 rounded-2xl p-6 border border-red-200">
                        <h3 class="font-bold text-red-800 mb-4">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                        
                        <div class="flex flex-wrap gap-3">
                            <button onclick="clearExpired()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ
                            </button>
                            
                            <button onclick="exportAllData()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-200">
                                üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                            </button>
                            
                            <button onclick="clearAllData()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700">
                                ‚ò†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                            </button>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <button onclick="saveSettings()" class="w-full py-3 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                    
                </div>
            </section>

        </main>
    </div>

    <script src="js/config.js"></script>
    <script>
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π URL –¥–ª—è –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ Netlify
        CONFIG.API_URL = '';
        console.log('‚úÖ Admin CONFIG: proxy —á–µ—Ä–µ–∑ Netlify');
        
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º hasBackend - –≤—Å–µ–≥–¥–∞ true, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏
        window.hasBackend = () => true;
        
        // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        fetch('/health')
            .then(r => r.json())
            .then(d => console.log('‚úÖ Health check OK:', d))
            .catch(e => console.error('‚ùå Health check failed:', e));
    </script>
    <script src="js/api.js"></script>
    <script>
        // === Admin Panel Logic ===
        
        let currentSection = 'dashboard';
        let isAuthenticated = false;
        
        // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ API
        API.getHeaders = function() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π userId –∏–ª–∏ –ø—Ä–æ–±—É–µ–º ENV
            const userId = window._adminUserId || ENV.getUserId();
            return {
                'Content-Type': 'application/json',
                'X-Telegram-ID': userId ? String(userId) : ''
            };
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        function getTelegramUser() {
            // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º Telegram WebApp
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                console.log('üì± User from Telegram WebApp');
                return window.Telegram.WebApp.initDataUnsafe.user;
            }
            
            // 2. –ü—Ä–æ–±—É–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–µ—Ä–µ–¥–∞–Ω–æ –∏–∑ index.html)
            try {
                const params = new URLSearchParams(window.location.search);
                const uid = params.get('uid');
                if (uid) {
                    console.log('üîó User from URL params:', uid);
                    return {
                        id: uid,
                        first_name: params.get('name') || 'Admin',
                        username: params.get('uname') || ''
                    };
                }
            } catch (e) {
                console.error('URL params error:', e);
            }
            
            // 3. –ü—Ä–æ–±—É–µ–º sessionStorage (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
            try {
                const stored = sessionStorage.getItem('pomoechka_telegram_user');
                if (stored) {
                    console.log('üíæ User from sessionStorage');
                    return JSON.parse(stored);
                }
            } catch (e) {}
            
            // 4. –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('üîß Dev mode user');
                return { id: 'dev', first_name: 'Dev' };
            }
            
            return null;
        }
        
        // === Authentication ===
        async function checkAuth() {
            const authStatus = document.getElementById('authStatus');
            const authError = document.getElementById('authError');
            const authSetup = document.getElementById('authSetup');
            const authNotTelegram = document.getElementById('authNotTelegram');
            
            console.log('üöÄ Admin checkAuth started');
            console.log('üìç URL:', window.location.href);
            console.log('üìç Search:', window.location.search);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                console.log('üì± Telegram WebApp initialized');
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = getTelegramUser();
            const userId = user?.id;
            
            console.log('üë§ User:', user);
            console.log('üÜî UserId:', userId);
            
            if (!user || !userId) {
                console.log('‚ùå No user found');
                authStatus.classList.add('hidden');
                authNotTelegram.classList.remove('hidden');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º userId –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤
            window._adminUserId = String(userId);
            
            console.log('üîç Checking auth for user:', userId);
            console.log('üåê Using Netlify proxy');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ API —Å –±—ç–∫–µ–Ω–¥–∞ (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ Netlify)
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.log('üì§ Fetching check-admin...');
                const adminCheck = await fetch('/api/auth/check-admin', {
                    method: 'GET',
                    headers: { 
                        'X-Telegram-ID': String(userId),
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                console.log('üì• Admin response status:', adminCheck.status);
                
                if (!adminCheck.ok) {
                    throw new Error(`HTTP ${adminCheck.status}`);
                }
                
                const adminData = await adminCheck.json();
                console.log('üîê Admin check:', adminData);
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω –∏–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                if (adminData.isAdmin || adminData.isCreator) {
                    console.log('‚úÖ User is admin/creator, showing panel');
                    showAdminPanel(user, adminData.isCreator);
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ
                console.log('üì§ Fetching check-creator...');
                const creatorCheck = await fetch('/api/auth/check-creator', {
                    method: 'GET',
                    headers: { 
                        'X-Telegram-ID': String(userId),
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                const creatorData = await creatorCheck.json();
                console.log('üîç Creator check:', creatorData);
                
                // –ï—Å–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É
                if (creatorData.hasCreator === false) {
                    console.log('üëë No creator found, showing setup');
                    authStatus.classList.add('hidden');
                    authSetup.classList.remove('hidden');
                    document.getElementById('setupUserId').textContent = userId;
                    return;
                }
                
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω
                console.log('‚õî User is not admin');
                authStatus.classList.add('hidden');
                authError.classList.remove('hidden');
                
            } catch (error) {
                console.error('‚ùå Auth check error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                
                // –ï—Å–ª–∏ fetch –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º XMLHttpRequest –∫–∞–∫ fallback
                console.log('üîÑ Trying XMLHttpRequest fallback...');
                try {
                    const result = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', '/api/auth/check-admin');
                        xhr.setRequestHeader('X-Telegram-ID', String(userId));
                        xhr.setRequestHeader('Accept', 'application/json');
                        xhr.onload = () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve(JSON.parse(xhr.responseText));
                            } else {
                                reject(new Error(`XHR HTTP ${xhr.status}`));
                            }
                        };
                        xhr.onerror = () => reject(new Error('XHR Network Error'));
                        xhr.send();
                    });
                    
                    console.log('‚úÖ XHR result:', result);
                    if (result.isAdmin || result.isCreator) {
                        showAdminPanel(user, result.isCreator);
                        return;
                    }
                } catch (xhrError) {
                    console.error('‚ùå XHR also failed:', xhrError);
                }
                
                // –ï—Å–ª–∏ –≤—Å—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏
                authStatus.classList.add('hidden');
                authError.classList.remove('hidden');
                document.querySelector('#authError p:last-child').textContent = 
                    '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
            }
        }
        
        async function setupCreator() {
            const user = getTelegramUser();
            const userId = window._adminUserId || user?.id;
            const botToken = document.getElementById('setupBotToken')?.value?.trim() || 'placeholder:token';
            
            console.log('üîß Setting up creator:', userId);
            
            if (!userId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/setup-creator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-ID': String(userId)
                    },
                    body: JSON.stringify({
                        botToken: botToken,
                        name: user?.first_name || 'Admin',
                        username: user?.username || ''
                    })
                });
                
                const result = await response.json();
                console.log('‚úÖ Setup result:', result);
                
                if (result.success || result.alreadyExists) {
                    showAdminPanel(user || { first_name: 'Admin', id: userId }, true);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è'));
                }
            } catch (error) {
                console.error('Setup creator error:', error);
                alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${error.message}`);
            }
        }
        
        function showAdminPanel(user, isCreator) {
            isAuthenticated = true;
            
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            
            // Update admin info
            document.getElementById('adminAvatar').textContent = user.first_name?.charAt(0) || '?';
            document.getElementById('adminName').textContent = user.first_name || 'Admin';
            document.getElementById('adminRole').textContent = isCreator ? 'üëë –°–æ–∑–¥–∞—Ç–µ–ª—å' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            
            // Show creator settings if creator
            if (isCreator) {
                document.getElementById('creatorSettings').classList.remove('hidden');
                loadCreatorSettings();
            }
            
            // Load data
            loadDashboard();
            loadItems();
            loadReports();
        }
        
        // === Navigation ===
        function showSection(sectionId) {
            currentSection = sectionId;
            
            document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById('section-' + sectionId)?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-emerald-600', 'text-white');
                link.classList.add('text-gray-300');
            });
            document.querySelector(`[href="#${sectionId}"]`)?.classList.add('bg-emerald-600', 'text-white');
            document.querySelector(`[href="#${sectionId}"]`)?.classList.remove('text-gray-300');
            
            const titles = { 'dashboard': 'üìä –î–∞—à–±–æ—Ä–¥', 'items': 'üì¶ –û–±—ä—è–≤–ª–µ–Ω–∏—è', 'reports': '‚ö†Ô∏è –ñ–∞–ª–æ–±—ã', 'settings': '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏' };
            document.getElementById('sectionTitle').textContent = titles[sectionId] || sectionId;
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }
        
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
        }
        
        // === Dashboard ===
        async function loadDashboard() {
            try {
                const analytics = await API.getAnalytics();
                
                document.getElementById('stat-total').textContent = analytics.totalItems;
                document.getElementById('stat-active').textContent = analytics.activeItems;
                document.getElementById('stat-taken').textContent = analytics.takenItems;
                document.getElementById('stat-reports').textContent = analytics.pendingReports;
                
                // Update reports badge
                const badge = document.getElementById('reportsBadge');
                if (analytics.pendingReports > 0) {
                    badge.textContent = analytics.pendingReports;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                // Load recent items
                try {
                    const itemsResponse = await fetch(`${CONFIG.API_URL}/api/admin/items?limit=5`, {
                        headers: API.getHeaders()
                    });
                    const items = itemsResponse.ok ? await itemsResponse.json() : [];
                    renderRecentItems((items || []).slice(0, 5));
                } catch (e) {
                    console.error('Recent items error:', e);
                    renderRecentItems([]);
                }
                
                // Render charts
                renderCharts(analytics, items);
                
                document.getElementById('lastUpdate').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString('ru');
            } catch (e) {
                console.error('Dashboard error:', e);
            }
        }
        
        function renderRecentItems(items) {
            const container = document.getElementById('recentItems');
            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                    <span class="text-2xl">${item.emoji || 'üì¶'}</span>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${escapeHtml(item.title)}</p>
                        <p class="text-sm text-gray-500">${item.author?.name || '–ê–Ω–æ–Ω–∏–º'} ‚Ä¢ ${formatTimeAgo(item.createdAt)}</p>
                    </div>
                    <span class="status-badge status-${item.status}">
                        ${getStatusText(item.status)}
                    </span>
                </div>
            `).join('');
        }
        
        function renderCharts(analytics, items) {
            // Status chart
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx && !statusCtx.chart) {
                statusCtx.chart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–ê–∫—Ç–∏–≤–Ω—ã–µ', '–ó–∞–±—Ä–∞–ª–∏', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'],
                        datasets: [{
                            data: [analytics.activeItems, analytics.takenItems, analytics.expiredItems],
                            backgroundColor: ['#10b981', '#6366f1', '#f59e0b']
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
                });
            }
            
            // Categories chart
            const catCounts = {};
            items.forEach(item => {
                catCounts[item.category] = (catCounts[item.category] || 0) + 1;
            });
            
            const catCtx = document.getElementById('categoriesChart');
            if (catCtx && !catCtx.chart) {
                catCtx.chart = new Chart(catCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(catCounts).map(c => getCategoryName(c)),
                        datasets: [{
                            label: '–û–±—ä—è–≤–ª–µ–Ω–∏–π',
                            data: Object.values(catCounts),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }
        }
        
        // === Items ===
        async function loadItems() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                const response = await fetch(`${CONFIG.API_URL}/api/admin/items`, {
                    headers: API.getHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const items = await response.json();
                console.log('‚úÖ Loaded items:', items.length);
                renderItemsTable(items || []);
            } catch (e) {
                console.error('‚ùå Items error:', e);
                renderItemsTable([]);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const tbody = document.getElementById('itemsTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</td></tr>`;
                }
            }
        }
        
        function renderItemsTable(items) {
            const tbody = document.getElementById('itemsTableBody');
            if (!tbody) return;
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</td></tr>';
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —ç–º–æ–¥–∑–∏
            function getCategoryEmoji(category) {
                const emojis = {
                    'food': 'üçï',
                    'clothes': 'üëï',
                    'electronics': 'üì±',
                    'furniture': 'ü™ë',
                    'books': 'üìö',
                    'toys': 'üß∏',
                    'other': 'üì¶'
                };
                return emojis[category] || 'üì¶';
            }
            
            tbody.innerHTML = items.map(item => {
                const category = item.category || 'other';
                const emoji = getCategoryEmoji(category);
                const title = escapeHtml(item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
                const address = escapeHtml(item.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω');
                const status = item.status || 'active';
                const reportsCount = item.reports_count || 0;
                const createdAt = item.created_at || item.createdAt;
                const telegramId = item.telegram_id || '';
                
                return `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${emoji}</span>
                            <div class="min-w-0 flex-1">
                                <p class="font-medium text-gray-800 text-sm truncate">${title}</p>
                                <p class="text-xs text-gray-500 truncate">${address}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-xs text-gray-600" title="Telegram ID: ${telegramId}">${telegramId ? 'ID:' + telegramId.slice(-4) : '‚Äî'}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="status-badge status-${status}">${getStatusText(status)}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="text-xs ${reportsCount > 0 ? 'text-red-600 font-semibold' : 'text-gray-500'}">${reportsCount}</span>
                    </td>
                    <td class="px-4 py-3 text-xs text-gray-500">
                        ${formatDate(createdAt)}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-1">
                            ${status === 'hidden' ? `<button onclick="unhideItem(${item.id})" class="p-1.5 text-green-600 hover:bg-green-50 rounded" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚úÖ</button>` : ''}
                            ${status !== 'hidden' ? `<button onclick="hideItem(${item.id})" class="p-1.5 text-amber-600 hover:bg-amber-50 rounded" title="–°–∫—Ä—ã—Ç—å">üö´</button>` : ''}
                            <button onclick="deleteItem(${item.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        async function filterItems() {
            const search = document.getElementById('itemSearch')?.value || '';
            const status = document.getElementById('itemStatus')?.value || '';
            
            try {
                let url = `${CONFIG.API_URL}/api/admin/items`;
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url, {
                    headers: API.getHeaders()
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let items = await response.json();
                
                // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É (—Ç–∞–∫ –∫–∞–∫ –ø–æ–∏—Å–∫ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
                if (search) {
                    const searchLower = search.toLowerCase();
                    items = items.filter(item => 
                        item.title?.toLowerCase().includes(searchLower) ||
                        item.description?.toLowerCase().includes(searchLower) ||
                        item.address?.toLowerCase().includes(searchLower)
                    );
                }
                
                renderItemsTable(items || []);
            } catch (e) {
                console.error('Filter error:', e);
                renderItemsTable([]);
            }
        }
        
        async function hideItem(id) {
            if (!confirm('–°–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/items/${id}`, {
                    method: 'PATCH',
                    headers: API.getHeaders(),
                    body: JSON.stringify({ status: 'hidden' })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                await loadItems();
                await loadDashboard();
            } catch (e) {
                console.error('Hide item error:', e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        async function unhideItem(id) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/items/${id}`, {
                    method: 'PATCH',
                    headers: API.getHeaders(),
                    body: JSON.stringify({ status: 'active' })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                await loadItems();
                await loadDashboard();
            } catch (e) {
                console.error('Unhide item error:', e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        async function deleteItem(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/items/${id}`, {
                    method: 'DELETE',
                    headers: API.getHeaders()
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                await loadItems();
                await loadDashboard();
            } catch (e) {
                console.error('Delete item error:', e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        // === Reports ===
        async function loadReports() {
            try {
                const reports = await API.getReports({});
                renderReports(reports);
                
                const pending = reports.filter(r => r.status === 'pending').length;
                document.getElementById('pendingCount').textContent = `${pending} –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏`;
            } catch (e) {
                console.error('Reports error:', e);
            }
        }
        
        function renderReports(reports) {
            const container = document.getElementById('reportsList');
            if (reports.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">–ù–µ—Ç –∂–∞–ª–æ–±</p>';
                return;
            }
            
            const reasons = {
                'fake': 'üö´ –§–µ–π–∫',
                'dangerous': '‚ö†Ô∏è –û–ø–∞—Å–Ω–æ',
                'spam': 'üì¢ –°–ø–∞–º',
                'wrong_location': 'üìç –ù–µ–≤–µ—Ä–Ω–æ–µ –º–µ—Å—Ç–æ'
            };
            
            container.innerHTML = reports.map(r => `
                <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center gap-4">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">–û–±—ä—è–≤–ª–µ–Ω–∏–µ #${r.itemId}</p>
                        <p class="text-sm text-amber-600">${reasons[r.reason] || r.reason}</p>
                        <p class="text-xs text-gray-400">${formatTimeAgo(r.createdAt)}</p>
                    </div>
                    <span class="status-badge status-${r.status}">
                        ${r.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : '‚úÖ –†–µ—à–µ–Ω–æ'}
                    </span>
                    ${r.status === 'pending' ? `
                        <div class="flex gap-2">
                            <button onclick="resolveReport(${r.id}, ${r.itemId}, true)" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200">
                                –°–∫—Ä—ã—Ç—å
                            </button>
                            <button onclick="resolveReport(${r.id}, ${r.itemId}, false)" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200">
                                –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        async function resolveReport(reportId, itemId, hideItem) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/reports/${reportId}/resolve`, {
                    method: 'PATCH',
                    headers: API.getHeaders(),
                    body: JSON.stringify({ hideItem })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to resolve report');
                }
                
                loadReports();
                loadDashboard();
            } catch (error) {
                console.error('Resolve report error:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // === Settings ===
        async function addAdmin() {
            const input = document.getElementById('newAdminId');
            const adminId = parseInt(input.value);
            
            if (!adminId) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/admins`, {
                    method: 'POST',
                    headers: API.getHeaders(),
                    body: JSON.stringify({ telegramId: adminId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add admin');
                }
                
                alert(`–ê–¥–º–∏–Ω ${adminId} –¥–æ–±–∞–≤–ª–µ–Ω`);
                input.value = '';
                await loadAdminsList();
            } catch (error) {
                console.error('Add admin error:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function loadAdminsList() {
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/admins`, {
                    headers: API.getHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load admins');
                
                const admins = await response.json();
                renderAdminsList(admins);
            } catch (error) {
                console.error('Load admins error:', error);
                // Fallback
                renderAdminsList([]);
            }
        }
        
        function renderAdminsList(admins) {
            const container = document.getElementById('adminsList');
            const nonCreatorAdmins = admins.filter(a => !a.isCreator);
            
            if (nonCreatorAdmins.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤</p>';
                return;
            }
            
            container.innerHTML = nonCreatorAdmins.map(admin => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <span class="font-mono">${admin.telegramId}</span>
                    <button onclick="removeAdmin(${admin.telegramId})" class="text-red-600 hover:text-red-800">‚úï</button>
                </div>
            `).join('');
        }
        
        async function removeAdmin(telegramId) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ${telegramId}?`)) return;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/admins/${telegramId}`, {
                    method: 'DELETE',
                    headers: API.getHeaders()
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to remove admin');
                }
                
                alert('–ê–¥–º–∏–Ω —É–¥–∞–ª—ë–Ω');
                await loadAdminsList();
            } catch (error) {
                console.error('Remove admin error:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function clearExpired() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è?')) return;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/api/admin/items?status=expired`, {
                    headers: API.getHeaders()
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const items = await response.json();
                
                for (const item of items || []) {
                    const deleteResponse = await fetch(`${CONFIG.API_URL}/api/admin/items/${item.id}`, {
                        method: 'DELETE',
                        headers: API.getHeaders()
                    });
                    
                    if (!deleteResponse.ok) {
                        console.warn('Failed to delete item:', item.id);
                    }
                }
                
                await loadItems();
                await loadDashboard();
                alert('–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã');
            } catch (e) {
                console.error('Clear expired error:', e);
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        function exportAllData() {
            const data = {
                items: JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.items) || '[]'),
                reports: JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.reports) || '[]'),
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pomoechka_export_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        
        function exportItems() {
            const items = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.items) || '[]');
            const csv = 'ID,–ù–∞–∑–≤–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–°—Ç–∞—Ç—É—Å,–ê–≤—Ç–æ—Ä,–ñ–∞–ª–æ–±—ã,–î–∞—Ç–∞\n' + 
                items.map(i => `${i.id},"${i.title}",${i.category},${i.status},"${i.author?.name}",${i.reports||0},${formatDate(i.createdAt)}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'items.csv';
            a.click();
        }
        
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            
            localStorage.clear();
            location.reload();
        }
        
        async function loadCreatorSettings() {
            try {
                const settings = await API.getAdminSettings();
                document.getElementById('creatorIdDisplay').value = settings.creatorId || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                await loadAdminsList();
            } catch (error) {
                console.error('Load creator settings error:', error);
            }
        }
        
        async function saveSettings() {
            try {
                const settings = {
                    itemLifetime: parseInt(document.getElementById('settingLifetime').value),
                    autoHideReports: parseInt(document.getElementById('settingAutoHide').checked ? '3' : '0'),
                    requirePhoto: document.getElementById('settingRequirePhoto').checked,
                    preModeration: false,
                    karma: {
                        publish: parseInt(document.getElementById('karmaPublish').value),
                        taken: parseInt(document.getElementById('karmaTaken').value),
                        extend: 2,
                        thanks: 5
                    }
                };
                
                const response = await fetch(`${CONFIG.API_URL}/api/admin/settings`, {
                    method: 'POST',
                    headers: API.getHeaders(),
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save settings');
                }
                
                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (error) {
                console.error('Save settings error:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        function refreshData() {
            loadDashboard();
            loadItems();
            loadReports();
        }
        
        // === Helpers ===
        function escapeHtml(str = '') {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function formatTimeAgo(ts) {
            if (!ts) return '';
            const sec = Math.floor((Date.now() - ts) / 1000);
            if (sec < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (sec < 3600) return `${Math.floor(sec / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (sec < 86400) return `${Math.floor(sec / 3600)} —á –Ω–∞–∑–∞–¥`;
            return `${Math.floor(sec / 86400)} –¥–Ω –Ω–∞–∑–∞–¥`;
        }
        
        function formatDate(ts) {
            if (!ts) return '';
            return new Date(ts).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }
        
        function getStatusText(status) {
            const texts = { active: 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ', taken: '‚úÖ –ó–∞–±—Ä–∞–ª–∏', expired: '‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ', hidden: 'üö´ –°–∫—Ä—ã—Ç–æ' };
            return texts[status] || status;
        }
        
        function getCategoryName(cat) {
            const names = { furniture: '–ú–µ–±–µ–ª—å', construction: '–°—Ç—Ä–æ–π–∫–∞', electronics: '–¢–µ—Ö–Ω–∏–∫–∞', books: '–ö–Ω–∏–≥–∏', plants: '–†–∞—Å—Ç–µ–Ω–∏—è', other: '–ü—Ä–æ—á–µ–µ' };
            return names[cat] || cat;
        }
    </script>

</body>
</html>
