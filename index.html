<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–º–æ–µ—á–∫–∞ –∫–æ—Ä–º–∏—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
</head>
<body class="bg-gray-100">

<!-- Auth Screen -->
<div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center">
        <div class="text-6xl mb-4">üóëÔ∏è</div>
        <h1 class="text-2xl font-bold mb-2">–ü–æ–º–æ–µ—á–∫–∞ –∫–æ—Ä–º–∏—Ç</h1>
        <p class="text-gray-500 mb-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div id="authError" class="hidden text-red-500"></div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">
    
    <!-- Feed Screen -->
    <div id="screen-feed" class="min-h-screen bg-gray-50">
        <div class="bg-white px-4 py-3 border-b flex justify-between items-center">
            <h1 class="text-xl font-bold">–ü–æ–º–æ–µ—á–∫–∞ üóëÔ∏è‚ú®</h1>
            <div class="flex gap-2">
                <button id="adminBtn" class="hidden w-10 h-10 rounded-full bg-purple-500 text-white" onclick="openAdminPanel()">‚öôÔ∏è</button>
                <button class="w-10 h-10 rounded-full bg-emerald-500 text-white font-bold" onclick="showScreen('profile')">üë§</button>
            </div>
        </div>
        
        <div id="feedItems" class="p-4 space-y-4 pb-24">
            <div class="text-center py-12 text-gray-500">
                <div class="text-5xl mb-4">üì¶</div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
            </div>
        </div>
        
        <button onclick="showScreen('add')" class="fixed bottom-20 right-4 w-14 h-14 bg-emerald-500 rounded-full text-white text-2xl shadow-lg">+</button>
        
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t px-4 py-2 flex justify-around">
            <button onclick="showScreen('feed')" class="text-center text-emerald-600"><div>üìã</div><div class="text-xs">–õ–µ–Ω—Ç–∞</div></button>
            <button onclick="showScreen('add')" class="text-center text-gray-400"><div>‚ûï</div><div class="text-xs">–î–æ–±–∞–≤–∏—Ç—å</div></button>
            <button onclick="showScreen('profile')" class="text-center text-gray-400"><div>üë§</div><div class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</div></button>
        </div>
    </div>
    
    <!-- Add Screen -->
    <div id="screen-add" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white px-4 py-3 border-b flex items-center gap-3">
            <button onclick="showScreen('feed')" class="text-2xl">‚Üê</button>
            <h1 class="text-lg font-bold">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ö–æ–¥–∫—É</h1>
        </div>
        <div class="p-4 space-y-4">
            <div class="bg-white rounded-xl p-4">
                <label class="block text-sm font-semibold mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="itemTitle" type="text" placeholder="–ß—Ç–æ —ç—Ç–æ?" class="w-full p-3 bg-gray-100 rounded-lg">
            </div>
            <div class="bg-white rounded-xl p-4">
                <label class="block text-sm font-semibold mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="itemDesc" placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ, –≥–¥–µ –ª–µ–∂–∏—Ç..." class="w-full p-3 bg-gray-100 rounded-lg h-24"></textarea>
            </div>
            <button onclick="publishItem()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üöÄ</button>
        </div>
    </div>
    
    <!-- Profile Screen -->
    <div id="screen-profile" class="hidden min-h-screen bg-gray-50">
        <div class="bg-emerald-500 px-4 py-6 text-white">
            <button onclick="showScreen('feed')" class="text-2xl mb-4">‚Üê</button>
            <h1 id="profileName" class="text-xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <p id="profileKarma">‚≠ê 0 –∫–∞—Ä–º—ã</p>
        </div>
        <div class="p-4">
            <button id="adminPanelBtn" class="hidden w-full bg-purple-500 text-white p-4 rounded-xl font-semibold mb-4" onclick="openAdminPanel()">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
            <div class="bg-white rounded-xl p-4">
                <h3 class="font-bold mb-2">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
                <p class="text-gray-500 text-sm">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>
            </div>
        </div>
    </div>
</div>

<!-- Creator Modal -->
<div id="creatorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl p-6 max-w-sm w-full">
        <div class="text-center mb-4">
            <div class="text-5xl mb-2">üëë</div>
            <h2 class="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h2>
            <p class="text-gray-500 text-sm">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞</p>
        </div>
        <input id="botToken" type="text" placeholder="123456:ABC..." class="w-full p-3 border rounded-lg mb-4">
        <button onclick="setupCreator()" class="w-full bg-emerald-500 text-white py-3 rounded-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button onclick="closeCreatorModal()" class="w-full py-2 text-gray-500 mt-2">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
</div>

<script>
// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–≤—Å—Ç—Ä–æ–µ–Ω–∞!)
// ============================================
var CONFIG = {
    API_URL: 'https://pomoechka-mvp.onrender.com',
    APP_NAME: '–ü–æ–º–æ–µ—á–∫–∞ –∫–æ—Ä–º–∏—Ç'
};

console.log('‚úÖ CONFIG:', CONFIG.API_URL);

// ============================================
// API (–≤—Å—Ç—Ä–æ–µ–Ω!)
// ============================================
var API = {
    userId: null,
    userData: null,
    
    init: function(user) {
        this.userId = user ? String(user.id) : null;
        this.userData = user;
        console.log('‚úÖ API init:', this.userId);
    },
    
    request: function(endpoint, options) {
        options = options || {};
        var url = CONFIG.API_URL + endpoint;
        var headers = { 'Content-Type': 'application/json' };
        if (this.userId) headers['X-Telegram-ID'] = this.userId;
        if (this.userData) headers['X-Telegram-Data'] = JSON.stringify(this.userData);
        
        return fetch(url, {
            method: options.method || 'GET',
            headers: headers,
            body: options.body
        }).then(function(r) { return r.json(); });
    }
};

// ============================================
// –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
// ============================================
var currentUser = null;
var currentUserData = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM –≥–æ—Ç–æ–≤');
    setTimeout(startApp, 200);
});

async function startApp() {
    console.log('üöÄ –ó–∞–ø—É—Å–∫...');
    
    // Telegram
    var tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
        try { tg.ready(); tg.expand(); } catch(e) {}
    }
    
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    currentUser = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
    if (!currentUser) {
        console.log('‚ö†Ô∏è –ú–æ–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        currentUser = { id: 123456789, first_name: '–¢–µ—Å—Ç', username: 'test' };
        showDevBanner();
    }
    console.log('üë§', currentUser.id, currentUser.first_name);
    
    // API
    API.init(currentUser);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
    try {
        currentUserData = await API.request('/api/auth/me');
        console.log('‚úÖ User data:', currentUserData);
    } catch(e) {
        console.warn('‚ö†Ô∏è Backend error:', e);
        currentUserData = { telegram_id: currentUser.id, name: currentUser.first_name, karma: 0 };
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    var perms = await checkPermissions();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    // –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è
    if (!perms.hasCreator) {
        document.getElementById('creatorModal').classList.remove('hidden');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    updateProfile();
    loadFeed();
    
    console.log('üéâ –ì–æ—Ç–æ–≤–æ!');
}

async function checkPermissions() {
    var result = { isAdmin: false, isCreator: false, hasCreator: true };
    try {
        var r = await API.request('/api/auth/check-admin');
        result.isAdmin = r.isAdmin || false;
        result.isCreator = r.isCreator || false;
    } catch(e) {}
    try {
        var c = await API.request('/api/auth/check-creator');
        result.hasCreator = c.hasCreator !== false;
    } catch(e) {}
    
    if (result.isAdmin || result.isCreator) {
        document.getElementById('adminBtn').classList.remove('hidden');
        document.getElementById('adminPanelBtn').classList.remove('hidden');
    }
    
    console.log('üîê –ü—Ä–∞–≤–∞:', result);
    return result;
}

function updateProfile() {
    var u = currentUserData || currentUser;
    document.getElementById('profileName').textContent = u.name || u.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileKarma').textContent = '‚≠ê ' + (u.karma || 0) + ' –∫–∞—Ä–º—ã';
}

async function loadFeed() {
    try {
        var items = await API.request('/api/items?status=active');
        var container = document.getElementById('feedItems');
        
        if (!items || items.length === 0) {
            container.innerHTML = '<div class="text-center py-12 text-gray-500"><div class="text-5xl mb-4">üì¶</div><p>–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p><p class="text-sm">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p></div>';
            return;
        }
        
        container.innerHTML = items.map(function(item) {
            return '<div class="bg-white rounded-xl p-4 shadow-sm"><h3 class="font-bold">' + item.title + '</h3><p class="text-gray-500 text-sm">' + (item.description || '') + '</p></div>';
        }).join('');
    } catch(e) {
        console.warn('‚ö†Ô∏è Feed error:', e);
    }
}

function showScreen(name) {
    console.log('üì±', name);
    document.querySelectorAll('[id^="screen-"]').forEach(function(el) {
        el.classList.add('hidden');
    });
    var target = document.getElementById('screen-' + name);
    if (target) target.classList.remove('hidden');
}

async function publishItem() {
    var title = document.getElementById('itemTitle').value.trim();
    var desc = document.getElementById('itemDesc').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
    }
    
    try {
        await API.request('/api/items', {
            method: 'POST',
            body: JSON.stringify({ title: title, description: desc, category: 'other' })
        });
        alert('‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
        document.getElementById('itemTitle').value = '';
        document.getElementById('itemDesc').value = '';
        showScreen('feed');
        loadFeed();
    } catch(e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

async function setupCreator() {
    var token = document.getElementById('botToken').value.trim();
    if (!token) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω'); return; }
    
    try {
        await API.request('/api/auth/setup-creator', {
            method: 'POST',
            body: JSON.stringify({ botToken: token })
        });
        closeCreatorModal();
        alert('üéâ –í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å!');
        document.getElementById('adminBtn').classList.remove('hidden');
        document.getElementById('adminPanelBtn').classList.remove('hidden');
    } catch(e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

function closeCreatorModal() {
    document.getElementById('creatorModal').classList.add('hidden');
}

function openAdminPanel() {
    window.location.href = 'admin.html';
}

function showDevBanner() {
    var d = document.createElement('div');
    d.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#f59e0b;color:white;padding:8px;text-align:center;z-index:9999;font-size:13px;';
    d.textContent = '‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏';
    document.body.prepend(d);
}
</script>

</body>
</html>