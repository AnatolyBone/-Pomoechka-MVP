<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–º–æ–µ—á–∫–∞ –∫–æ—Ä–º–∏—Ç üóëÔ∏è‚ú®</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- App Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Telegram theme variables -->
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #10b981;
            --tg-theme-button-text-color: #ffffff;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Auth Screen (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-emerald-100 via-teal-50 to-cyan-100">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4">üóëÔ∏è</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">–ü–æ–º–æ–µ—á–∫–∞ –∫–æ—Ä–º–∏—Ç</h1>
            <p class="text-gray-500 mb-6">Telegram –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ–±–º–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∫–∞–º–∏</p>
            
            <div id="authStatus" class="mb-6">
                <div class="animate-pulse flex items-center justify-center gap-2 text-gray-500">
                    <div class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></div>
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...
                </div>
            </div>
            
            <div id="authError" class="hidden bg-red-50 text-red-700 p-4 rounded-xl mb-4">
                <p class="font-semibold">‚õî –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
                <p class="text-sm mt-1">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram</p>
            </div>
            
            <div id="authNotTelegram" class="hidden bg-amber-50 text-amber-700 p-4 rounded-xl">
                <p class="font-semibold">üì± –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram</p>
                <p class="text-sm mt-1">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram Mini App</p>
            </div>
        </div>
    </div>

    <!-- Main App (—Å–∫—Ä—ã—Ç–æ –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
    <div id="mainApp" class="hidden min-h-screen">
        
        <!-- Screen 1: Map (Primary) -->
        <div id="screen-map" class="screen active h-screen bg-gray-50 flex flex-col">
            
            <!-- Header -->
            <div class="bg-white px-4 py-3 border-b border-gray-100 z-10">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">üìç –ö–∞—Ä—Ç–∞ –Ω–∞—Ö–æ–¥–æ–∫</h1>
                        <p id="userLocation" class="text-xs text-gray-500">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="adminBtn" class="hidden w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm font-bold shadow" onclick="openAdminPanel()" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
                            ‚öôÔ∏è
                        </button>
                        <button onclick="showScreen('profile')" id="profileBtn" class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold shadow">
                            ?
                        </button>
                    </div>
                </div>
                
                <!-- Radius selector -->
                <div class="flex gap-2">
                    <button class="radius-btn px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold" data-radius="0.5" onclick="setRadius(0.5)">500–º</button>
                    <button class="radius-btn active px-3 py-1.5 bg-emerald-500 text-white rounded-full text-xs font-semibold" data-radius="2" onclick="setRadius(2)">2–∫–º</button>
                    <button class="radius-btn px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold" data-radius="5" onclick="setRadius(5)">5–∫–º</button>
                    <button class="radius-btn px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold" data-radius="10" onclick="setRadius(10)">10–∫–º</button>
                </div>
            </div>
            
            <!-- Map Area -->
            <div class="flex-1 relative">
                <div id="mapContainer" class="absolute inset-0 bg-gradient-to-br from-green-50 via-blue-50 to-indigo-50">
                    <!-- Markers –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                    <div id="mapMarkers"></div>
                    
                    <!-- Current location -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                        <div class="w-4 h-4 bg-blue-500 rounded-full border-4 border-white shadow-lg"></div>
                        <div class="absolute inset-0 w-4 h-4 bg-blue-500 rounded-full animate-ping"></div>
                    </div>
                </div>
                
                <!-- Bottom sheet preview -->
                <div id="mapPreview" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl p-4 pb-20">
                    <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-3"></div>
                    <p id="mapItemsCount" class="text-xs text-gray-500 text-center">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </p>
                </div>
            </div>
            
            <!-- Floating Add Button -->
            <button onclick="showScreen('add')" class="floating-btn absolute bottom-36 right-4 w-14 h-14 bg-emerald-500 rounded-full flex items-center justify-center text-white text-2xl font-bold hover:bg-emerald-600 transition z-20 shadow-lg">
                +
            </button>
            
            <!-- Bottom Nav -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-around z-20">
                <button class="bottom-nav-btn flex flex-col items-center text-emerald-600" data-screen="map">
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span class="text-xs font-semibold">–ö–∞—Ä—Ç–∞</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400" data-screen="feed">
                    <span class="text-xl">üìã</span>
                    <span class="text-xs">–õ–µ–Ω—Ç–∞</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400" data-screen="add">
                    <span class="text-xl">‚ûï</span>
                    <span class="text-xs">–î–æ–±–∞–≤–∏—Ç—å</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400 relative" data-screen="profile">
                    <span class="text-xl">üë§</span>
                    <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </div>

        <!-- Screen 2: Feed -->
        <div id="screen-feed" class="screen h-screen bg-gray-50 flex flex-col">
            
            <!-- Header -->
            <div class="bg-white px-4 py-3 border-b border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">–ü–æ–º–æ–µ—á–∫–∞ üóëÔ∏è‚ú®</h1>
                        <p id="feedLocation" class="text-xs text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="adminBtnFeed" class="hidden w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white text-sm font-bold shadow" onclick="openAdminPanel()" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
                            ‚öôÔ∏è
                        </button>
                        <button onclick="showScreen('profile')" id="profileBtnFeed" class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold shadow">
                            ?
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="relative">
                    <input type="text" id="feedSearch" placeholder="–ü–æ–∏—Å–∫: –¥–∏–≤–∞–Ω, —Å—Ç—É–ª—å—è, –∫–Ω–∏–≥–∏..." 
                           class="w-full pl-10 pr-4 py-2.5 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                           oninput="handleSearch(this.value)">
                    <span class="absolute left-3 top-2.5">üîç</span>
                </div>
                
                <!-- Tabs / Categories -->
                <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
                    <button class="tab-btn active px-3 py-1.5 text-xs font-semibold border-b-2 border-emerald-500 text-emerald-600 whitespace-nowrap" data-category="all">üî• –í—Å–µ</button>
                    <button class="tab-btn px-3 py-1.5 text-xs font-semibold border-b-2 border-transparent text-gray-500 whitespace-nowrap" data-category="furniture">üõãÔ∏è –ú–µ–±–µ–ª—å</button>
                    <button class="tab-btn px-3 py-1.5 text-xs font-semibold border-b-2 border-transparent text-gray-500 whitespace-nowrap" data-category="construction">üß± –°—Ç—Ä–æ–π</button>
                    <button class="tab-btn px-3 py-1.5 text-xs font-semibold border-b-2 border-transparent text-gray-500 whitespace-nowrap" data-category="electronics">üì∫ –¢–µ—Ö–Ω–∏–∫–∞</button>
                    <button class="tab-btn px-3 py-1.5 text-xs font-semibold border-b-2 border-transparent text-gray-500 whitespace-nowrap" data-category="books">üìö –ö–Ω–∏–≥–∏</button>
                </div>
            </div>
            
            <!-- Important notice -->
            <div class="mx-4 mt-3 safety-banner rounded-xl p-2 text-xs text-amber-800">
                üí° <strong>–ó–∞–º–µ—Ç–∏–ª ‚Üí –û—Ç–º–µ—Ç–∏–ª ‚Üí –ü–æ–º–æ–≥!</strong> –ü—É–±–ª–∏–∫—É–π—Ç–µ —Ç–æ, —á—Ç–æ —É–∂–µ –ª–µ–∂–∏—Ç —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤.
            </div>
            
            <!-- Feed -->
            <div id="feedItems" class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">‚è≥</div>
                    <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
            
            <!-- Floating Add Button -->
            <button onclick="showScreen('add')" class="floating-btn absolute bottom-20 right-4 w-14 h-14 bg-emerald-500 rounded-full flex items-center justify-center text-white text-2xl font-bold hover:bg-emerald-600 transition z-10 shadow-lg">
                +
            </button>
            
            <!-- Bottom Nav -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-around">
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400" data-screen="map">
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span class="text-xs">–ö–∞—Ä—Ç–∞</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-emerald-600" data-screen="feed">
                    <span class="text-xl">üìã</span>
                    <span class="text-xs font-semibold">–õ–µ–Ω—Ç–∞</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400" data-screen="add">
                    <span class="text-xl">‚ûï</span>
                    <span class="text-xs">–î–æ–±–∞–≤–∏—Ç—å</span>
                </button>
                <button class="bottom-nav-btn flex flex-col items-center text-gray-400 relative" data-screen="profile">
                    <span class="text-xl">üë§</span>
                    <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </div>

        <!-- Screen 3: Add Item -->
        <div id="screen-add" class="screen h-screen bg-gray-50 flex flex-col">
            
            <div class="bg-white px-4 py-3 border-b border-gray-100 flex items-center gap-3">
                <button onclick="showScreen('map')" class="text-2xl">‚Üê</button>
                <h1 class="text-lg font-bold text-gray-800">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Ö–æ–¥–∫—É</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <!-- Important notice -->
                <div class="safety-banner rounded-xl p-3">
                    <p class="text-sm text-amber-800">
                        ‚ö†Ô∏è <strong>–í–∞–∂–Ω–æ:</strong> –ü—É–±–ª–∏–∫—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ <strong>—É–∂–µ –ª–µ–∂–∏—Ç</strong> —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. 
                        –ú—ã –Ω–µ –ø—Ä–∏–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤–ª—è—Ç—å –≤–µ—â–∏ –Ω–∞ —É–ª–∏—Ü–µ!
                    </p>
                </div>
                
                <!-- Photo upload -->
                <div id="uploadZone" class="upload-zone rounded-2xl p-8 text-center bg-white cursor-pointer">
                    <div class="text-5xl mb-2">üì∑</div>
                    <p class="font-semibold text-gray-700">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π –Ω–∞—Ö–æ–¥–∫—É</p>
                    <p class="text-xs text-gray-500 mt-1">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</p>
                </div>
                
                <!-- Title -->
                <div class="bg-white rounded-2xl p-4">
                    <label class="text-sm font-semibold text-gray-700 block mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input id="itemTitle" type="text" placeholder="–ß—Ç–æ —ç—Ç–æ? (–¥–∏–≤–∞–Ω, –∫–Ω–∏–≥–∏, —Å—Ç—É–ª—å—è...)" 
                           class="w-full p-3 bg-gray-50 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <!-- Description -->
                <div class="bg-white rounded-2xl p-4">
                    <label class="text-sm font-semibold text-gray-700 block mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="itemDescription" placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–∑–º–µ—Ä, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..." 
                              class="w-full h-20 p-3 bg-gray-50 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                
                <!-- Categories -->
                <div class="bg-white rounded-2xl p-4">
                    <label class="text-sm font-semibold text-gray-700 block mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="furniture" onclick="selectCategory(this)">üõãÔ∏è –ú–µ–±–µ–ª—å</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="construction" onclick="selectCategory(this)">üß± –°—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="electronics" onclick="selectCategory(this)">üì∫ –¢–µ—Ö–Ω–∏–∫–∞</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="clothing" onclick="selectCategory(this)">üëï –û–¥–µ–∂–¥–∞</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="books" onclick="selectCategory(this)">üìö –ö–Ω–∏–≥–∏</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="plants" onclick="selectCategory(this)">ü™¥ –†–∞—Å—Ç–µ–Ω–∏—è</button>
                        <button class="category-chip px-3 py-1.5 bg-gray-100 rounded-full text-sm" data-category="other" onclick="selectCategory(this)">üì¶ –î—Ä—É–≥–æ–µ</button>
                    </div>
                </div>
                
                <!-- Location -->
                <div class="bg-white rounded-2xl p-4">
                    <label class="text-sm font-semibold text-gray-700 block mb-2">–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è?</label>
                    <button id="getLocationBtn" class="w-full flex items-center gap-3 p-3 bg-emerald-50 rounded-xl text-emerald-700 font-semibold" onclick="getCurrentLocation()">
                        <span class="text-xl">üìç</span>
                        <span>–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                        <span id="locationStatus" class="ml-auto"></span>
                    </button>
                    <input id="locationDetails" type="text" placeholder="–£—Ç–æ—á–Ω–∏: —É –ø–æ–¥—ä–µ–∑–¥–∞ 3, –∑–∞ –¥–æ–º–æ–º..." 
                           class="w-full mt-2 p-3 bg-gray-50 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <p id="locationInfo" class="text-xs text-gray-500 mt-2"></p>
                </div>
                
                <!-- Chat mode -->
                <div class="bg-white rounded-2xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-700">üí¨ –†–∞–∑—Ä–µ—à–∏—Ç—å —á–∞—Ç</p>
                            <p class="text-xs text-gray-500">–õ—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–±–µ</p>
                        </div>
                        <div id="chatToggle" class="toggle-switch active" onclick="toggleChat()"></div>
                    </div>
                </div>
                
                <!-- Lifetime notice -->
                <div class="bg-blue-50 rounded-xl p-3 text-sm text-blue-800">
                    ‚è∞ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ <strong>6 —á–∞—Å–æ–≤</strong>. 
                    –¢—ã —Å–º–æ–∂–µ—à—å –ø—Ä–æ–¥–ª–∏—Ç—å –µ–≥–æ –æ–¥–Ω–∏–º —Ç–∞–ø–æ–º.
                </div>
                
                <!-- Submit -->
                <button onclick="publishItem()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl text-lg hover:bg-emerald-600 transition shadow-lg">
                    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å üöÄ
                </button>
                
            </div>
        </div>

        <!-- Screen 4: Profile -->
        <div id="screen-profile" class="screen h-screen bg-gray-50 flex flex-col">
            
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 px-4 py-6 text-white">
                <button onclick="showScreen('map')" class="text-2xl mb-4">‚Üê</button>
                
                <div class="flex items-center gap-4">
                    <div id="userAvatar" class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center text-3xl font-bold backdrop-blur">
                        ?
                    </div>
                    <div>
                        <h1 id="userName" class="text-xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                        <p id="userUsername" class="text-emerald-100 text-sm">@username</p>
                        <p id="userLocationProfile" class="text-emerald-200 text-xs mt-1">üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...</p>
                    </div>
                </div>
                
                <!-- Karma -->
                <div class="mt-4 flex items-center gap-3">
                    <div class="karma-glow bg-gradient-to-r from-yellow-400 to-amber-500 px-4 py-2 rounded-full flex items-center gap-2">
                        <span class="text-xl">‚≠ê</span>
                        <span id="userKarma" class="font-bold text-lg">0</span>
                        <span class="text-sm opacity-80">–∫–∞—Ä–º—ã</span>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
                
                <!-- Stats -->
                <div id="userStats" class="grid grid-cols-3 gap-3">
                    <div class="bg-white rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-600">0</div>
                        <div class="text-xs text-gray-500">–í—ã–ª–æ–∂–µ–Ω–æ</div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-xs text-gray-500">–ó–∞–±—Ä–∞–ª–∏</div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-orange-600">~0–∫–≥</div>
                        <div class="text-xs text-gray-500">–°–ø–∞—Å–µ–Ω–æ</div>
                    </div>
                </div>
                
                <!-- Admin Panel Button (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
                <div id="adminPanelBtn" class="hidden bg-purple-50 rounded-2xl p-4 border-2 border-purple-200">
                    <button onclick="openAdminPanel()" class="w-full flex items-center justify-center gap-3 p-3 bg-purple-500 text-white rounded-xl font-semibold">
                        <span class="text-xl">‚öôÔ∏è</span>
                        <span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
                    </button>
                </div>
                
                <!-- My items -->
                <div class="bg-white rounded-2xl p-4">
                    <h3 class="font-bold text-gray-800 mb-3">üì¶ –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
                    <div id="myItemsList" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Screen 5: Item Detail -->
        <div id="screen-detail" class="screen h-screen bg-gray-50 flex flex-col">
            <div id="detailContent" class="flex-1 overflow-y-auto">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-3xl p-6 m-4 text-center animate-slide-up">
                <div class="text-6xl mb-4" id="successEmoji">üéâ</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2" id="successTitle">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!</h2>
                <p class="text-gray-600 mb-4" id="successText">+10 –∫–∞—Ä–º—ã –ø–æ–ª—É—á–µ–Ω–æ</p>
                <button onclick="hideModal()" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl">
                    –û—Ç–ª–∏—á–Ω–æ!
                </button>
            </div>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-3xl p-4 m-4 w-full max-w-sm animate-slide-up">
                <h2 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</h2>
                <div class="space-y-2">
                    <button onclick="submitReport('fake')" class="report-option w-full p-3 border border-gray-200 rounded-xl text-left text-sm hover:bg-red-50">
                        üö´ –§–µ–π–∫ / –≤–µ—â–∏ –Ω–µ—Ç –Ω–∞ –º–µ—Å—Ç–µ
                    </button>
                    <button onclick="submitReport('dangerous')" class="report-option w-full p-3 border border-gray-200 rounded-xl text-left text-sm hover:bg-red-50">
                        ‚ò¢Ô∏è –û–ø–∞—Å–Ω—ã–µ –æ—Ç—Ö–æ–¥—ã
                    </button>
                    <button onclick="submitReport('spam')" class="report-option w-full p-3 border border-gray-200 rounded-xl text-left text-sm hover:bg-red-50">
                        üì¢ –°–ø–∞–º / —Ä–µ–∫–ª–∞–º–∞
                    </button>
                    <button onclick="submitReport('wrong_location')" class="report-option w-full p-3 border border-gray-200 rounded-xl text-left text-sm hover:bg-red-50">
                        üìç –ù–µ–≤–µ—Ä–Ω–∞—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
                    </button>
                </div>
                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="w-full mt-4 py-3 text-gray-500 font-semibold">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>

        <!-- Creator Setup Modal (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫) -->
        <div id="creatorSetupModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-3xl p-6 m-4 w-full max-w-sm animate-slide-up">
                <div class="text-6xl mb-4 text-center">üëë</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2 text-center">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è</h2>
                <p class="text-gray-600 mb-4 text-center text-sm">
                    –≠—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫. –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, —á—Ç–æ –≤—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å.
                </p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ Telegram</label>
                    <input type="text" id="botTokenInput" placeholder="123456789:ABCdef..." 
                           class="w-full p-3 bg-gray-50 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 font-mono">
                    <p class="text-xs text-gray-500 mt-2">
                        –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É <a href="https://t.me/BotFather" target="_blank" class="text-emerald-600 underline">@BotFather</a>
                    </p>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="setupCreator()" class="flex-1 bg-emerald-500 text-white font-bold py-3 rounded-xl">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button onclick="skipCreatorSetup()" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-3 rounded-xl">
                        –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Provider Selection Modal -->
        <div id="mapProviderModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-3xl p-6 m-4 w-full max-w-sm animate-slide-up">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É</h2>
                <div class="space-y-3">
                    <button onclick="openMapProvider('yandex', window.mapLat, window.mapLng)" class="w-full p-4 border-2 border-gray-200 rounded-xl text-left hover:border-emerald-500 hover:bg-emerald-50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üó∫Ô∏è</span>
                            <div>
                                <p class="font-semibold text-gray-800">–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</p>
                                <p class="text-xs text-gray-500">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="openMapProvider('2gis', window.mapLat, window.mapLng)" class="w-full p-4 border-2 border-gray-200 rounded-xl text-left hover:border-emerald-500 hover:bg-emerald-50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üó∫Ô∏è</span>
                            <div>
                                <p class="font-semibold text-gray-800">2–ì–ò–°</p>
                                <p class="text-xs text-gray-500">–û—Ç–∫—Ä—ã—Ç—å –≤ 2–ì–ò–°</p>
                            </div>
                        </div>
                    </button>
                    <button onclick="openMapProvider('google', window.mapLat, window.mapLng)" class="w-full p-4 border-2 border-gray-200 rounded-xl text-left hover:border-emerald-500 hover:bg-emerald-50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üó∫Ô∏è</span>
                            <div>
                                <p class="font-semibold text-gray-800">Google Maps</p>
                                <p class="text-xs text-gray-500">–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps</p>
                            </div>
                        </div>
                    </button>
                </div>
                <button onclick="document.getElementById('mapProviderModal').classList.add('hidden')" class="w-full mt-4 py-3 text-gray-500 font-semibold">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        function waitForConfig() {
            return new Promise((resolve) => {
                if (window.CONFIG) {
                    resolve();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 50–º—Å
                const interval = setInterval(() => {
                    if (window.CONFIG) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 50);
                
                // –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    clearInterval(interval);
                    resolve(); // –†–∞–∑—Ä–µ—à–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ CONFIG –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
                }, 5000);
            });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üì¶ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ CONFIG...');
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ CONFIG
            await waitForConfig();
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp
            if (window.Telegram?.WebApp) {
                // –î–∞–µ–º Telegram WebApp –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            await initApp();
        });
        
        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            console.error('üö® showError:', message);
            
            const authScreen = document.getElementById('authScreen');
            const authStatus = document.getElementById('authStatus');
            const authNotTelegram = document.getElementById('authNotTelegram');
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            if (authStatus) authStatus.classList.add('hidden');
            if (authNotTelegram) authNotTelegram.classList.add('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—à–∏–±–∫–∏
            let errorContainer = document.getElementById('authError');
            
            if (!errorContainer && authScreen) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'authError';
                authScreen.appendChild(errorContainer);
            }
            
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div style="text-align: center; padding: 24px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">‚õî</div>
                        <h2 style="color: #ef4444; margin-bottom: 12px; font-size: 20px;">–û—à–∏–±–∫–∞</h2>
                        <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">${message}</p>
                        <button onclick="location.reload()" style="
                            padding: 12px 32px;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        ">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                `;
                errorContainer.classList.remove('hidden');
            }
            
            if (authScreen) {
                authScreen.style.display = 'flex';
                authScreen.classList.remove('hidden');
            }
        }
        
        // –ü–æ–∫–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        function showDevModeWarning() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            const existing = document.getElementById('dev-warning');
            if (existing) existing.remove();
            
            const warning = document.createElement('div');
            warning.id = 'dev-warning';
            warning.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(90deg, #ff9800, #ff5722);
                    color: white;
                    padding: 10px 16px;
                    text-align: center;
                    font-size: 13px;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                ">
                    ‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        margin-left: 16px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 4px 12px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">‚úï</button>
                </div>
            `;
            document.body.prepend(warning);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.body.style.paddingTop = '44px';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function hideAuthScreen() {
            const authScreen = document.getElementById('authScreen');
            if (authScreen) {
                authScreen.style.display = 'none';
                authScreen.classList.add('hidden');
            }
        }

        function showMainApp() {
            const mainApp = document.getElementById('mainApp');
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.classList.remove('hidden');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initializeUser(telegramUser) {
            console.log('üë§ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramUser.id);
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
            if (window.API && typeof API.getCurrentUser === 'function') {
                try {
                    const userData = await API.getCurrentUser();
                    if (userData) {
                        window.currentUserData = userData;
                        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±—ç–∫–µ–Ω–¥–∞:', userData);
                        return;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞:', e.message);
                }
            }
            
            // Fallback - –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            window.currentUserData = {
                id: telegramUser.id,
                telegram_id: telegramUser.id,
                name: `${telegramUser.first_name} ${telegramUser.last_name || ''}`.trim(),
                username: telegramUser.username || '',
                karma: 0,
                items_count: 0,
                created_at: new Date().toISOString()
            };
            console.log('üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', window.currentUserData);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        async function checkPermissions() {
            console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...');
            
            let isAdmin = false;
            let isCreator = false;
            
            if (window.API) {
                try {
                    if (typeof API.isAdmin === 'function') {
                        isAdmin = await API.isAdmin();
                    }
                    if (typeof API.isCreator === 'function') {
                        isCreator = await API.isCreator();
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤:', e.message);
                }
            }
            
            console.log('üîê –ü—Ä–∞–≤–∞:', { isAdmin, isCreator });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞
            const adminBtn = document.getElementById('adminPanelBtn');
            if (adminBtn) {
                if (isAdmin || isCreator) {
                    adminBtn.classList.remove('hidden');
                    adminBtn.style.display = 'block';
                } else {
                    adminBtn.classList.add('hidden');
                    adminBtn.style.display = 'none';
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∫–∏ –≤ —Ö–µ–¥–µ—Ä–µ
            if (isAdmin || isCreator) {
                document.getElementById('adminBtn')?.classList.remove('hidden');
                document.getElementById('adminBtnFeed')?.classList.remove('hidden');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è
            if (!isCreator && window.API) {
                try {
                    const hasCreator = await checkIfCreatorExists();
                    if (!hasCreator) {
                        showCreatorSetupModal();
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:', e.message);
                }
            }
            
            window.userPermissions = { isAdmin, isCreator };
        }

        async function checkIfCreatorExists() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–∑–¥–∞—Ç–µ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ
            try {
                if (!window.CONFIG || !window.CONFIG.API_URL) return true;
                
                const response = await fetch(`${window.CONFIG.API_URL}/api/admin/settings`, {
                    headers: { 
                        'X-Telegram-ID': window.currentUser?.id?.toString() || '',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return !!data.creatorId;
                }
                return true; // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
            } catch (e) {
                return true; // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
            }
        }

        function showCreatorSetupModal() {
            const modal = document.getElementById('creatorSetupModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }
        
        async function initApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ CONFIG
            let attempts = 0;
            while (!window.CONFIG && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            
            if (!window.CONFIG) {
                showError('CONFIG –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –∏ –∑–∞–≥—Ä—É–∑–∫—É js/config.js');
                return;
            }
            
            console.log('‚úÖ CONFIG –∑–∞–≥—Ä—É–∂–µ–Ω, API_URL:', window.CONFIG.API_URL);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            const tg = window.Telegram?.WebApp;
            
            // –í–∞–∂–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –°–û–î–ï–†–ñ–ò–ú–û–ï, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ª–∏—á–∏–µ –æ–±—ä–µ–∫—Ç–∞
            const hasInitData = !!tg?.initData && tg.initData.length > 0;
            const initDataUnsafe = tg?.initDataUnsafe || {};
            const hasInitDataUnsafe = Object.keys(initDataUnsafe).length > 0;
            const hasUser = !!initDataUnsafe?.user;
            
            console.log('üì± Telegram detection:', {
                hasTelegramWebApp: !!tg,
                hasInitData,
                hasInitDataUnsafe,
                hasUser,
                initData: tg?.initData?.substring(0, 50) + '...',
                initDataUnsafeKeys: Object.keys(initDataUnsafe),
                version: tg?.version
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (tg) {
                try {
                    tg.ready();
                    tg.expand();
                    console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', e);
                }
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let tgUser = initDataUnsafe?.user;
            console.log('üë§ Telegram user:', tgUser ? { id: tgUser.id, name: tgUser.first_name } : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
            
            // === –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã ===
            const isLocalDev = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            // –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º: –Ω–µ—Ç initData –ò–õ–ò –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const isBrowserMode = !hasInitData || !hasUser;
            
            console.log('üîß –†–µ–∂–∏–º:', { isLocalDev, isBrowserMode, hasUser });
            
            if (!tgUser) {
                if (isLocalDev || isBrowserMode) {
                    // === –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ / —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ ===
                    console.log('‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    tgUser = {
                        id: 12345678,
                        first_name: '–¢–µ—Å—Ç',
                        last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        username: 'test_user'
                    };
                    showDevModeWarning();
                } else {
                    // –†–µ–∞–ª—å–Ω—ã–π Telegram, –Ω–æ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
                    console.error('‚ùå Telegram –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –Ω–æ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é –±–æ—Ç–∞.');
                    return;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ
            window.currentUser = tgUser;
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', tgUser.id, tgUser.first_name);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º API
            let backendAvailable = false;
            if (window.API) {
                try {
                    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API...');
                    backendAvailable = await API.init();
                    console.log('‚úÖ API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, backend –¥–æ—Å—Ç—É–ø–µ–Ω:', backendAvailable);
                } catch (e) {
                    console.error('‚ùå API init error:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è API –º–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
            }
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await initializeUser(tgUser);
                
                // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                hideAuthScreen();
                showMainApp();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                await checkPermissions();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                if (window.App) {
                    App.telegramUser = tgUser;
                    
                    if (window.initAppComponents) {
                        initAppComponents();
                    }
                    
                    showScreen('map');
                }
                
                console.log('üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!');
                
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }
        
        async function setupCreator() {
            const token = document.getElementById('botTokenInput').value.trim();
            const btn = document.querySelector('#creatorSetupModal button[onclick="setupCreator()"]');
            
            if (!token) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
                return;
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ:—Å—Ç—Ä–æ–∫–∞)
            if (!/^\d+:[A-Za-z0-9_-]+$/.test(token)) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 123456789:ABCdef...');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
            if (!window.API) {
                alert('‚ùå API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–∞
            if (!window.CONFIG) {
                alert('‚ùå CONFIG –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É js/config.js');
                console.error('CONFIG –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (!window.CONFIG.API_URL) {
                alert('‚ùå API_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ CONFIG. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ js/config.js');
                console.error('CONFIG.API_URL:', window.CONFIG.API_URL);
                return;
            }
            
            console.log('‚úÖ CONFIG –∑–∞–≥—Ä—É–∂–µ–Ω, API_URL:', window.CONFIG.API_URL);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±—ç–∫–µ–Ω–¥–∞
            try {
                const healthCheck = await fetch(`${window.CONFIG.API_URL}/health`);
                if (!healthCheck.ok) {
                    throw new Error('Health check failed');
                }
            } catch (e) {
                alert(`‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: ${window.CONFIG.API_URL}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n2. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞\n3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö`);
                console.error('Backend health check failed:', e);
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            }
            
            try {
                const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                
                if (!tgUser) {
                    throw new Error('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                
                const hasBackendCheck = () => window.CONFIG && !!window.CONFIG.API_URL;
                
                console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è...', {
                    apiUrl: window.CONFIG?.API_URL,
                    telegramId: tgUser.id,
                    hasBackend: hasBackendCheck()
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
                const result = await API.setupCreator({
                    name: tgUser.first_name,
                    username: tgUser.username,
                    first_name: tgUser.first_name,
                    botToken: token // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                });
                
                console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', result);
                
                if (result.success) {
                    document.getElementById('creatorSetupModal').classList.add('hidden');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏
                    document.getElementById('adminBtn')?.classList.remove('hidden');
                    document.getElementById('adminBtnFeed')?.classList.remove('hidden');
                    document.getElementById('adminPanelBtn')?.classList.remove('hidden');
                    
                    if (window.showToast) {
                        showToast('‚úÖ –°–æ–∑–¥–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
                    } else {
                        alert('‚úÖ –°–æ–∑–¥–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                console.error('‚ùå Setup creator error:', e);
                
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–æ–∑–¥–∞—Ç–µ–ª—è';
                
                if (e.message.includes('Failed to fetch') || e.message.includes('fetch')) {
                    errorMessage = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\n` +
                        `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n` +
                        `1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n` +
                        `2. URL –±—ç–∫–µ–Ω–¥–∞: ${CONFIG.API_URL}\n` +
                        `3. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞: ${CONFIG.API_URL}/health`;
                } else if (e.message) {
                    errorMessage = `‚ùå ${e.message}`;
                }
                
                alert(errorMessage);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
            }
        }
        
        function skipCreatorSetup() {
            document.getElementById('creatorSetupModal').classList.add('hidden');
        }
        
        function openAdminPanel() {
            window.location.href = 'admin.html';
        }
        
        function openMapProvider(provider, lat, lng) {
            document.getElementById('mapProviderModal').classList.add('hidden');
            
            let url = '';
            switch(provider) {
                case 'yandex':
                    url = `https://yandex.ru/maps/?pt=${lng},${lat}&z=16`;
                    break;
                case '2gis':
                    url = `https://2gis.ru/search/${lat},${lng}`;
                    break;
                case 'google':
                    url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                    break;
            }
            
            if (url) {
                window.open(url, '_blank');
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç—ã (–∑–∞–º–µ–Ω—è–µ—Ç openInMaps)
        window.openInMaps = function(lat, lng) {
            window.mapLat = lat;
            window.mapLng = lng;
            document.getElementById('mapProviderModal').classList.remove('hidden');
        };
    </script>

</body>
</html>

